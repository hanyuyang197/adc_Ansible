---
- name: 完整测试场景 - HTTP
  collections:
    - horizon.modules
  hosts: adc_servers
  gather_facts: no
  vars:
    # adc_ip变量已移除，使用inventory_hostname替代
    adc_username: "admin"
    adc_password: "admin"

  tasks:
    #####################################################################
    # 1. 登录ADC设备
    #####################################################################
    - name: 登录ADC设备
      adc_login:
        ip: "{{ inventory_hostname }}"
        username: "{{ adc_username }}"
        password: "{{ adc_password }}"
      register: login_result

    - name: 显示登录结果
      debug:
        var: login_result

    #####################################################################
    # 2. 创建健康检查
    #####################################################################
    - name: 添加HTTP健康检查
      adc_slb_healthcheck:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "add_healthcheck"
        name: "http_healthcheck_test"
        hc_type: "http"
        retry: 3
        interval: 5
        timeout: 5
        up_check_cnt: 1
        wait_all_retry: 0
        auto_disable: 0
        alias_ipv4_src: ""
        alias_ipv6_src: ""
        interface: ""
        alias_ipv4: ""
        alias_port: 80
        alias_ipv6: ""
        port: 80
        host: ""
        url: "GET /"
        trans_mode: 0
        username: ""
        password: ""
        code: "200"
        http_version: "HTTP 1.1"
      register: add_hc_result
      when: login_result is succeeded

    - name: 显示添加健康检查结果
      debug:
        var: add_hc_result
      when: add_hc_result is defined

    #####################################################################
    # 3. 创建节点
    #####################################################################
    - name: 添加第一个节点
      adc_slb_node:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "add_node"
        tc_name: ""
        graceful_time: 0
        graceful_delete: 0
        graceful_disable: 0
        graceful_persist: 0
        name: "192.168.1.101_test"
        host: "192.168.1.101"
        domain_ip_version: 0
        weight: 1
        healthcheck: "http_healthcheck_test"
        upnum: 0
        status: 1
        conn_limit: 1000
        template: "192.168.1.101_test"
        conn_rate_limit: 2011
        cl_log: "1"
        desc_rserver: ""
        request_rate_limit: 0
        slow_start_type: 0
        slow_start_recover: 15
        slow_start_rate: 0
        slow_start_from: 128
        slow_start_step: 2
        slow_start_interval: 10
        slow_start_interval_num: 6
        slow_start_tail: 4096
        ports:
          - port_number: 80
            protocol: 0
            status: 1
            weight: 1
            conn_limit: 0
            conn_limit_log: 1
            graceful_time: 0
            graceful_delete: 0
            graceful_disable: 0
            graceful_persist: 0
            phm_profile: ""
            healthcheck: ""
            upnum: 0
            nat_strategy: ""
      register: add_node_result_1
      when: login_result is succeeded

    - name: 显示添加第一个节点结果
      debug:
        var: add_node_result_1
      when: add_node_result_1 is defined

    - name: 添加第二个节点
      adc_slb_node:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "add_node"
        tc_name: ""
        graceful_time: 0
        graceful_delete: 0
        graceful_disable: 0
        graceful_persist: 0
        name: "192.168.1.102_test"
        host: "192.168.1.102"
        domain_ip_version: 0
        weight: 1
        healthcheck: "http_healthcheck_test"
        upnum: 0
        status: 1
        conn_limit: 1000
        template: "192.168.1.102_test"
        conn_rate_limit: 2012
        cl_log: "1"
        desc_rserver: ""
        request_rate_limit: 0
        slow_start_type: 0
        slow_start_recover: 15
        slow_start_rate: 0
        slow_start_from: 128
        slow_start_step: 2
        slow_start_interval: 10
        slow_start_interval_num: 6
        slow_start_tail: 4096
        ports:
          - port_number: 80
            protocol: 0
            status: 1
            weight: 1
            conn_limit: 0
            conn_limit_log: 1
            graceful_time: 0
            graceful_delete: 0
            graceful_disable: 0
            graceful_persist: 0
            phm_profile: ""
            healthcheck: ""
            upnum: 0
            nat_strategy: ""
      register: add_node_result_2
      when: login_result is succeeded

    - name: 显示添加第二个节点结果
      debug:
        var: add_node_result_2
      when: add_node_result_2 is defined

    #####################################################################
    # 4. 创建服务池
    #####################################################################
    - name: 添加服务池
      adc_slb_pool:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "add_pool"
        name: "http_pool_test"
        protocol: 0
        lb_method: 0
        upnum: 0
        healthcheck: "http_healthcheck_test"
        action_on_service_down: 0
        aux_node_log: 0
        up_members_at_least_status: 0
        up_members_at_least_num: 1
        up_members_at_least_type: 0
      register: add_pool_result
      when: login_result is succeeded

    - name: 显示添加服务池结果
      debug:
        var: add_pool_result
      when: add_pool_result is defined

    #####################################################################
    # 5. 将节点添加到服务池
    #####################################################################
    - name: 将第一个节点添加到服务池
      adc_slb_pool:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "add_pool_node"
        pool_name: "http_pool_test"
        node: "192.168.1.101_test"
        port: 80
        protocol: 0
        priority: 1
        weight: 1
        status: 1
        conn_limit: 0
      register: add_pool_node_result_1
      when: login_result is succeeded

    - name: 显示将第一个节点添加到服务池结果
      debug:
        var: add_pool_node_result_1
      when: add_pool_node_result_1 is defined

    - name: 将第二个节点添加到服务池
      adc_slb_pool:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "add_pool_node"
        pool_name: "http_pool_test"
        node: "192.168.1.102_test"
        port: 80
        protocol: 0
        priority: 1
        weight: 1
        status: 1
        conn_limit: 0
      register: add_pool_node_result_2
      when: login_result is succeeded

    - name: 显示将第二个节点添加到服务池结果
      debug:
        var: add_pool_node_result_2
      when: add_pool_node_result_2 is defined

    #####################################################################
    # 6. 创建虚拟地址
    #####################################################################
    - name: 添加IPv4虚拟地址
      adc_slb_va:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "add_va"
        va_type: "ipv4"
        name: "10.0.0.100_test"
        address: "10.0.0.100"
        status: 1
        arp_status: 1
        vrid: 0
        redistribution: 0
        policy_profile: ""
        natlog_profile: ""
        tc_name: ""
        icmp_probe: 0
        virtual_services: []
      register: add_va_result
      when: login_result is succeeded

    - name: 显示添加虚拟地址结果
      debug:
        var: add_va_result
      when: add_va_result is defined

    #####################################################################
    # 7. 创建虚拟服务
    #####################################################################
    - name: 添加HTTP虚拟服务
      adc_slb_va_vs:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "add_vs"
        va_name: "10.0.0.100_test"
        name: "http_vs_test"
        protocol: 12
        port: 80
        pool: "http_pool_test"
        connection_limit_status: 0
        connection_limit_number: 8000000
        vs_enable_intf: ""
        path_persist: 1
        status: 1
        desc_vport: ""
        snat_on_vip: 0
        auto_snat: 0
        send_reset: 0
        source_nat: ""
        tcp_profile: ""
        http_profile: ""
        srcip_persist: ""
        traffic_control: ""
        force_update_mac: 0
        dstip_persist: ""
        cookie_persist: ""
        sslid_persis: ""
        policy_profile: ""
        aclsnats: []
        immediate_action_on_service_down: 0
        vport_template_name: "default"
        service_last_hop: ""
        snat_port_preserve_enable: 0
        snat_port_preserve_type: 0
        connection_mirror: 0
        no_dest_nat: 0
        syncookie: 0
      register: add_vs_result
      when: login_result is succeeded

    - name: 显示添加虚拟服务结果
      debug:
        var: add_vs_result
      when: add_vs_result is defined

    #####################################################################
    # 8. 验证创建的资源
    #####################################################################
    - name: 获取节点列表
      adc_slb_node:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "list_nodes"
      register: list_nodes_result
      when: login_result is succeeded

    - name: 显示节点列表
      debug:
        var: list_nodes_result
      when: list_nodes_result is defined

    - name: 获取服务池列表
      adc_slb_pool:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "get_pools"
      register: list_pools_result
      when: login_result is succeeded

    - name: 显示服务池列表
      debug:
        var: list_pools_result
      when: list_pools_result is defined

    - name: 获取虚拟地址列表
      adc_slb_va:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "list_vas"
      register: list_vas_result
      when: login_result is succeeded

    - name: 显示虚拟地址列表
      debug:
        var: list_vas_result
      when: list_vas_result is defined

    - name: 获取健康检查列表
      adc_slb_healthcheck:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "list_healthchecks"
      register: list_hcs_result
      when: login_result is succeeded

    - name: 显示健康检查列表
      debug:
        var: list_hcs_result
      when: list_hcs_result is defined

    #####################################################################
    # 9. 清理资源（反向顺序删除）
    #####################################################################
    - name: 删除虚拟服务
      adc_slb_va_vs:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "delete_vs"
        va_name: "10.0.0.100_test"
        name: "http_vs_test"
        protocol: 12
        port: 80
      register: delete_vs_result
      when: login_result is succeeded

    - name: 显示删除虚拟服务结果
      debug:
        var: delete_vs_result
      when: delete_vs_result is defined

    - name: 删除虚拟地址
      adc_slb_va:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "delete_va"
        name: "10.0.0.100_test"
      register: delete_va_result
      when: login_result is succeeded

    - name: 显示删除虚拟地址结果
      debug:
        var: delete_va_result
      when: delete_va_result is defined

    - name: 从服务池中删除节点
      adc_slb_pool:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "delete_pool_node"
        pool_name: "http_pool_test"
        node: "192.168.1.101_test"
        port: 80
        protocol: 0
      register: delete_pool_node_result_1
      when: login_result is succeeded

    - name: 从服务池中删除第二个节点
      adc_slb_pool:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "delete_pool_node"
        pool_name: "http_pool_test"
        node: "192.168.1.102_test"
        port: 80
        protocol: 0
      register: delete_pool_node_result_2
      when: login_result is succeeded

    - name: 删除服务池
      adc_slb_pool:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "delete_pool"
        name: "http_pool_test"
      register: delete_pool_result
      when: login_result is succeeded

    - name: 显示删除服务池结果
      debug:
        var: delete_pool_result
      when: delete_pool_result is defined

    - name: 删除节点
      adc_slb_node:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "delete_node"
        name: "192.168.1.101_test"
      register: delete_node_result_1
      when: login_result is succeeded

    - name: 删除第二个节点
      adc_slb_node:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "delete_node"
        name: "192.168.1.102_test"
      register: delete_node_result_2
      when: login_result is succeeded

    - name: 显示删除节点结果
      debug:
        var: delete_node_result_1
      when: delete_node_result_1 is defined

    - name: 删除健康检查
      adc_slb_healthcheck:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "delete_healthcheck"
        name: "http_healthcheck_test"
      register: delete_hc_result
      when: login_result is succeeded

    - name: 显示删除健康检查结果
      debug:
        var: delete_hc_result
      when: delete_hc_result is defined

    #####################################################################
    # 10. 登出ADC设备
    #####################################################################
    - name: 登出ADC设备
      adc_logout:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
      register: logout_result
      when: login_result is succeeded

    - name: 显示登出结果
      debug:
        var: logout_result
      when: logout_result is defined
