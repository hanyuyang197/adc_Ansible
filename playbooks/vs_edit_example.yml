---
- name: 编辑虚拟服务示例
  hosts: adc_servers
  gather_facts: no
  vars:
    # adc_ip变量已移除，使用inventory_hostname替代
    adc_username: "admin"
    adc_password: "admin"

  tasks:
    - name: 登录ADC设备
      adc_login:
        ip: "{{ inventory_hostname }}"
        username: "{{ adc_username }}"
        password: "{{ adc_password }}"
      register: login_result

    - name: 显示登录结果
      debug:
        var: login_result

    - name: 编辑虚拟服务
      adc_slb_va_vs:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
        action: "edit_vs"
        va_name: "test_ipv4_va"
        name: "VS_NAME_1"
        protocol: 14
        port: 8000
        pool: "pool_http_1"
        connection_limit_status: 1
        connection_limit_number: 8000000
        vs_enable_intf: ""
        path_persist: 1
        status: 1
        desc_vport: ""
        snat_on_vip: 0
        auto_snat: 0
        vs_acl_id: 52  # 明确定义vs_acl_id，会包含在请求中
        aclnamev6: ""  # 明确定义aclnamev6，会包含在请求中
        erules: []  # 明确定义erules，会包含在请求中
        send_reset: 0
        syncookie: 0
        source_nat: ""
        no_dest_nat: 0
        connection_mirror: 0
        force_update_mac: 0
        snat_port_preserve_enable: 0
        snat_port_preserve_type: 0
        traffic_control: ""
        service_last_hop: "path_persist_pool_1"
        vport_template_name: "default"
        immediate_action_on_service_down: 0
        waf_profile: ""
        request_log_profile: ""
        http_profile: "http-profile-1"
        cache_profile: ""
        tcpagent_profile: ""
        serverssl_profile: ""
        connmulti_profile: ""
        srcip_persist: ""
        fallback_persist_srcip: ""
        policy_profile: ""
        aclsnats: []
      register: edit_vs_result
      when: login_result is succeeded

    - name: 显示编辑虚拟服务结果
      debug:
        var: edit_vs_result
      when: edit_vs_result is defined

    - name: 登出ADC设备
      adc_logout:
        ip: "{{ inventory_hostname }}"
        authkey: "{{ login_result.authkey }}"
      register: logout_result
      when: login_result is succeeded

    - name: 显示登出结果
      debug:
        var: logout_result
      when: logout_result is defined